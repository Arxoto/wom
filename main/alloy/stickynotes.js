const left=document.getElementById("left");left.oninput=parseMarkdown;const editor=document.getElementById("editor");editor.onclick=leftShowHide;const debounceSave=(()=>{let timerId=null;return function(){clearTimeout(timerId);timerId=setTimeout(()=>{chrome.storage.local.set({markdown:left.value},()=>{editor.innerText="saved";setTimeout(()=>{editor.innerText="editor"},300)});timerId=null},5e3)}})();chrome.storage.local.get("markdown",result=>{if(!result.markdown){chrome.storage.local.set({markdown:null});left.value="```\ncode\n```\n\n+ file:// or https:// \n+ describe\n\n- ul\n\n= ol\n\n# h1";left.style.display="block";return}left.value=result.markdown;parseMarkdown(false)});function leftShowHide(){left.style.display=left.style.display===""?"block":""}function parseMarkdown(doSave=true){let right=document.getElementById("right");right&&right.remove();right=document.createElement("div");right.id="right";document.body.appendChild(right);let code,ahref,ul,ol;let lines=left.value;lines=lines.split("\n");for(let i=0;i<lines.length;i++){const line=lines[i];if(line==="```"){if(code){right.appendChild(code);code=null;continue}code=document.createElement("pre");code.innerHTML="\n";continue}if(code){code.innerHTML+=line+"\n";continue}if(line.startsWith("+ ")){if(ahref){ahref.innerText=line.substring(2);right.appendChild(ahref);ahref=null;continue}ahref=document.createElement("a");const link=line.substring(2);if(link.startsWith("http://")||link.startsWith("https://")){ahref.href=link;ahref.target="_Blank"}else{ahref.href="";ahref.onclick=e=>{e.preventDefault();window.open("asyi://open/"+link,"_self")}}continue}if(line.startsWith("- ")){if(!ul){ul=document.createElement("ul");right.appendChild(ul)}let li=document.createElement("li");li.innerText=line.substring(2);ul.appendChild(li);continue}ul=null;if(line.startsWith("= ")){if(!ol){ol=document.createElement("ol");right.appendChild(ol)}let li=document.createElement("li");li.innerText=line.substring(2);ol.appendChild(li);continue}ol=null;if(line===""){right.appendChild(document.createElement("br"))}else if(line.startsWith("# ")){let dom=document.createElement("h1");dom.innerText=line.substring(2);right.appendChild(dom)}else if(line.startsWith("## ")){let dom=document.createElement("h2");dom.innerText=line.substring(3);right.appendChild(dom)}else{let dom=document.createElement("p");dom.innerText=line;right.appendChild(dom)}}if(doSave)debounceSave()}